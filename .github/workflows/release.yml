name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore 327TH_HB_AC.csproj

      - name: Publish release build
        run: dotnet publish 327TH_HB_AC.csproj --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true --output ./ProductionBuild

      - name: Confirm EXE exists
        shell: pwsh
        run: |
          if (-not (Test-Path "./ProductionBuild/327TH_HB_AC.exe")) {
            Write-Error "EXE not found in ProductionBuild folder."
            exit 1
          }
          Write-Host "EXE found. Size: $((Get-Item './ProductionBuild/327TH_HB_AC.exe').Length / 1MB) MB"

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path "./ProductionBuild/*" -DestinationPath "./327TH_HB_AC.zip" -Force
          Write-Host "ZIP created. Size: $((Get-Item './327TH_HB_AC.zip').Length / 1MB) MB"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          draft: false
          body: |
            327th Hawkbat Recording Policy â€” ${{ github.ref_name }}
            
            **Download and Installation:**
            1. Download `327TH_HB_AC.zip`
            2. Extract to any folder
            3. Run `327TH_HB_AC.exe` as Administrator
            
            All required files are included in the ZIP.
          files: |
            ./327TH_HB_AC.zip
